#!/bin/bash

STAT_USR_DIR="/opt/load_meter/stat"
STAT_USR="/var/log/user_load"
CURTIME=$(date +"%Y-%m-%d")

cd $STAT_USR_DIR

# Создаём директорию с датой
x=$(find . -type d -name "$CURTIME")
if [ "$x" = "" ]
then
	mkdir $CURTIME
	mkdir $CURTIME/per_user
fi

for USER in $(awk '{print}' /tmp/users_list)
do
	# СВОДНАЯ СТАТИСТИКА

	# CPU и память
	CPU=$(awk -v USER=$USER '/'"$USER"'/ {print}' $STAT_USR | awk -F ";" -v USER=$USER '{ sum += $3; } END { print sum; }' | sed 's/\./,/g')
	MEM=$(awk -v USER=$USER '/'"$USER"'/ {print}' $STAT_USR | awk -F ";" -v USER=$USER '{ sum += $4; } END { print sum; }'| sed 's/\./,/g')
	# Кол-во снятых метрик
	COUNT=$(awk -v USER=$USER '/'"$USER"'/ {print}' $STAT_USR | awk -v USER=$USER 'END {if (NR>0) print NR}')
	#a=$(expr "$CPU"/"$COUNT")
	if [ -n "$CPU" ] || [ -n "$MEM" ];
	then
		echo $USER";"$CPU";"$MEM";"$COUNT >> $STAT_USR_DIR/$CURTIME/total_load
	fi

	# ПО ПОЛЬЗОВАТЕЛЯМ

	awk -v USER=$USER '/'"$USER"'/ {print}' $STAT_USR | awk '{if (NR > 0) print}' >> $STAT_USR_DIR/$CURTIME/per_user/$USER

done

# Копируем файл статистики и очищаем его
cp $STAT_USR $STAT_USR_DIR/$CURTIME
:> $STAT_USR
